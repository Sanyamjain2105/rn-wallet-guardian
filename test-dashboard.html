<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è Wallet Guardian - Fund Protection Test</title>
    <!-- Primary ethers CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <!-- Fallback ethers CDN -->
    <script>
        // Update the always-visible balances section
        async function updateLiveBalances() {
            if (!window.connectedAccount || !window.safeAccount) return;
            try {
                const bal1 = await provider.getBalance(window.connectedAccount);
                const bal2 = await provider.getBalance(window.safeAccount);
                document.getElementById('liveBalances').innerHTML =
                    `<div><b>Connected Account:</b> ${window.connectedAccount}<br>Balance: ${ethers.utils.formatEther(bal1)} ETH</div>` +
                    `<div style='margin-top:10px'><b>Safe Account:</b> ${window.safeAccount}<br>Balance: ${ethers.utils.formatEther(bal2)} ETH</div>`;
            } catch (e) {
                document.getElementById('liveBalances').innerHTML = 'Error fetching balances.';
            }
        }
        async function updateBothBalances(addr1, addr2) {
            try {
                const bal1 = await provider.getBalance(addr1);
                const bal2 = await provider.getBalance(addr2);
                document.getElementById('bothBalances').innerHTML =
                    `<div><b>Connected Account:</b> ${addr1}<br>Balance: ${ethers.utils.formatEther(bal1)} ETH</div>` +
                    `<div style='margin-top:10px'><b>Safe Account:</b> ${addr2}<br>Balance: ${ethers.utils.formatEther(bal2)} ETH</div>`;
            } catch (e) {
                document.getElementById('bothBalances').innerHTML = 'Error fetching balances.';
            }
        }
        if (typeof ethers === 'undefined') {
            document.write('<script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"><\/script>');
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .step {
            margin-bottom: 20px;
        }

        .step h3 {
            color: #4dd0e1;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        /* Make dropdown option text white */
        select, select option {
            color: white !important;
            background: #2a5298;
        }
        }

        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .btn {
            background: linear-gradient(45deg, #29b6f6, #1976d2);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px 5px;
            min-width: 120px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(41, 182, 246, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(45deg, #4caf50, #45a049);
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .status {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .status.warning {
            background: rgba(255, 152, 0, 0.2);
            border-color: #ff9800;
        }

        .status.error {
            background: rgba(244, 67, 54, 0.2);
            border-color: #f44336;
        }

        .hidden {
            display: none !important;
        }

        .balance {
            font-size: 1.1rem;
            font-weight: bold;
            color: #81c784;
        }

        .addresses {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            word-break: break-all;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            width: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Wallet Guardian</h1>
            <p>Simple Fund Protection System</p>
        </div>

        <!-- Step 1: Connect Wallet -->
        <div class="card" id="connectSection">
            <div class="step">
                <h3>Step 1: Connect Your Wallet</h3>
                <button class="btn" id="connectBtn">Connect MetaMask</button>
                <div id="walletInfo" class="hidden">
                    <div class="status">
                        <strong>‚úÖ Wallet Connected</strong>
                        <div class="addresses" id="walletAddress"></div>
                        <div class="balance" id="walletBalance">0 ETH</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Setup Protection -->
        <div class="card hidden" id="setupSection">
            <div class="step">
                <h3>Step 2: Setup Fund Protection</h3>
                
                <div class="input-group">
                    <label>Contract Address (After Deployment)</label>
                    <input type="text" id="contractAddressInput" placeholder="0x... (Will be auto-filled after deployment)">
                    <button class="btn" id="setContractBtn" style="margin-top: 10px;">Set Contract Address</button>
                </div>

                <div class="input-group">
                    <label>Amount to Protect (ETH)</label>
                    <input type="number" id="amountInput" value="0.1" step="0.01" min="0.01">
                </div>

                <div class="input-group">
                    <!-- Removed cross-chain transfer option -->
                </div>

                <div class="input-group" id="destinationGroup">
                    <label>Destination Address (Your Safe Wallet)</label>
                    <input type="text" id="destinationInput" placeholder="0x...">
                    <small style="color: #81c784; margin-top: 5px; display: block;">
                        üí° For testing: Use one of the Anvil accounts below
                    </small>
                </div>

                <div class="input-group">
                    <label>Available Anvil Test Accounts</label>
                    <select id="anvilAccounts">
                        <option value="0x70997970C51812dc3A010C7d01b50e0d17dc79C8">Account #2: 0x7099...79C8</option>
                        <option value="0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC">Account #3: 0x3C44...93BC</option>
                        <option value="0x90F79bf6EB2c4f870365E785982E1f101E93b906">Account #4: 0x90F7...3b906</option>
                        <option value="0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65">Account #5: 0x15d3...6A65</option>
                    </select>
                    <button class="btn" id="useSelectedBtn" style="margin-top: 10px;">Use Selected Account</button>
                </div>

                <button class="btn btn-success" id="createProtectionBtn">Create Protection</button>
            </div>
        </div>

        <!-- Step 3: Test Attack -->
        <div class="card hidden" id="testSection">
            <div class="step">
                <h3>Step 3: Test Attack Simulation</h3>
                
                <div class="status" id="protectionStatus">
                    <strong>üõ°Ô∏è Protection Active</strong>
                    <div id="protectionDetails"></div>
                </div>

                <div class="input-group">
                    <label>Attack Type</label>
                    <select id="attackType">
                        <option value="Price Drop Attack">Price Drop Attack</option>
                        <option value="Large Transfer Attack">Suspicious Large Transfer</option>
                        <option value="Liquidation Attack">Liquidation Threat</option>
                        <option value="Manual Test">Manual Emergency Test</option>
                    </select>
                </div>

                <button class="btn btn-danger" id="simulateAttackBtn">üö® SIMULATE ATTACK</button>
            </div>
        </div>

        <!-- Step 4: Results -->
        <div class="card hidden" id="resultsSection">
            <div class="step">
                <h3>‚úÖ Attack Detected - Funds Protected!</h3>
                
                <div class="status" id="transferResult">
                    <strong>Emergency Transfer Successful</strong>
                    <div id="transferDetails"></div>
                </div>

                <button class="btn" id="resetBtn">Reset for New Test</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let provider;
        let signer;
        let userAccount;
        let guardianContract;
        let mockAttackContract;
        
        // Deployed contract addresses
        let callbackContractAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
        let mockAttackContractAddress = "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512";

        // Contract ABIs
        const callbackABI = [
            "function executeEmergencyTransfer(address user, uint256 amount, address destinationAddress) external",
            "event EmergencyTransferReceived(address indexed user, uint256 amount, address destinationAddress, uint256 timestamp)"
        ];
        
        const mockAttackABI = [
            "function triggerAttack(string memory attackType, address target) external",
            "function simulateLargeTransfer(address from, address to, uint256 amount) external",
            "function simulatePriceDrop(uint112 newReserve0, uint112 newReserve1) external",
            "event AttackSimulated(string attackType, address indexed target, uint256 amount)"
        ];

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check if ethers is loaded
            if (typeof ethers === 'undefined') {
                console.error('Ethers library not loaded');
                alert('Error: Ethers library failed to load. Please refresh the page.');
                return;
            }
            
            console.log('Ethers loaded:', ethers.version);
            setupEventListeners();
            checkMetaMask();
        });

        function setupEventListeners() {
            document.getElementById('connectBtn').onclick = connectWallet;
            document.getElementById('setContractBtn').onclick = setContractAddress;
            document.getElementById('useSelectedBtn').onclick = useSelectedAccount;
            document.getElementById('createProtectionBtn').onclick = createProtection;
            document.getElementById('simulateAttackBtn').onclick = simulateAttack;
            document.getElementById('resetBtn').onclick = resetTest;
        }

        function checkMetaMask() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask extension');
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('connectBtn').textContent = 'Install MetaMask';
            }
        }

        async function connectWallet() {
            try {
                document.getElementById('connectBtn').textContent = 'Connecting...';
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                // Switch to Anvil network (MetaMask custom network)
                await switchToAnvil();
                document.getElementById('walletAddress').textContent = userAccount;
                await updateBalance();
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('setupSection').classList.remove('hidden');
                document.getElementById('connectBtn').textContent = '‚úÖ Connected';
                document.getElementById('connectBtn').disabled = true;
            } catch (error) {
                console.error('Connection error:', error);
                alert('Failed to connect: ' + error.message);
                document.getElementById('connectBtn').textContent = 'Connect MetaMask';
            }
        }

        async function switchToAnvil() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x7A69' }], // 31337 in hex
                });
            } catch (error) {
                if (error.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x7A69',
                            chainName: 'Anvil Local',
                            rpcUrls: ['http://localhost:8546'],
                            nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 }
                        }],
                    });
                }
            }
            
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
        }

        async function updateBalance() {
            try {
                const balance = await signer.getBalance();
                const balanceInEth = ethers.utils.formatEther(balance);
                document.getElementById('walletBalance').textContent = `${parseFloat(balanceInEth).toFixed(4)} ETH`;
            } catch (error) {
                console.error('Balance update error:', error);
            }
        }

        function useSelectedAccount() {
            const selectedAccount = document.getElementById('anvilAccounts').value;
            document.getElementById('destinationInput').value = selectedAccount;
        }

        function setContractAddress() {
            const address = document.getElementById('contractAddressInput').value;
            if (!address || !ethers.utils.isAddress(address)) {
                alert('Please enter a valid contract address');
                return;
            }
            contractAddress = address;
            document.getElementById('setContractBtn').textContent = '‚úÖ Contract Set';
            document.getElementById('setContractBtn').disabled = true;
            
            // Show success message
            const status = document.createElement('div');
            status.className = 'status';
            status.innerHTML = `<strong>‚úÖ Contract Connected:</strong><br><small>${address}</small>`;
            document.getElementById('setupSection').appendChild(status);
        }

        async function createProtection() {
            try {
                const amount = document.getElementById('amountInput').value;
                const destination = document.getElementById('destinationInput').value;
                
                if (!amount || parseFloat(amount) <= 0) {
                    alert('Please enter a valid amount');
                    return;
                }
                
                if (!destination || !ethers.utils.isAddress(destination)) {
                    alert('Please enter a valid destination address');
                    return;
                }

                document.getElementById('createProtectionBtn').textContent = 'Creating...';
                
                // For testing, we'll simulate protection by just storing the details
                // In real implementation, this would interact with the Reactive Network
                
                // Initialize mock attack contract for testing
                mockAttackContract = new ethers.Contract(mockAttackContractAddress, mockAttackABI, signer);
                
                document.getElementById('testSection').classList.remove('hidden');
                document.getElementById('protectionDetails').innerHTML = `
                    <strong>üõ°Ô∏è Protection Setup Complete</strong><br>
                    Amount: ${amount} ETH<br>
                    Destination: ${destination}<br>
                    Callback Contract: ${callbackContractAddress}<br>
                    Mock Attack Contract: ${mockAttackContractAddress}<br>
                    <div id="bothBalances"></div>
                `;
                document.getElementById('createProtectionBtn').textContent = '‚úÖ Protection Created';
                document.getElementById('createProtectionBtn').disabled = true;
                await updateBothBalances(userAccount, destination);
                
            } catch (error) {
                console.error('Protection creation error:', error);
                alert('Failed to create protection: ' + error.message);
                document.getElementById('createProtectionBtn').textContent = 'Create Protection';
            }
        }

        async function simulateAttack() {
            try {
                document.getElementById('simulateAttackBtn').textContent = 'Simulating...';
                
                const attackType = document.getElementById('attackType').value;
                
                if (!mockAttackContract) {
                    alert('Mock attack contract not initialized. Please create protection first.');
                    return;
                }
                
                console.log('Triggering attack simulation...');
                
                // Call the mock attack contract to generate events
                const tx = await mockAttackContract.triggerAttack(attackType, userAccount);
                console.log('Attack transaction sent:', tx.hash);
                
                const receipt = await tx.wait();
                console.log('Attack transaction confirmed:', receipt);
                
                // REAL EMERGENCY TRANSFER - Direct ETH transfer to safe address
                setTimeout(async () => {
                    try {
                        const amount = document.getElementById('amountInput').value;
                        const destination = document.getElementById('destinationInput').value;
                        
                        console.log('Executing REAL emergency transfer...');
                        
                        // Direct ETH transfer to safe address (simulating what RN would do)
                        const transferAmount = ethers.utils.parseEther(amount);
                        const transferTx = await signer.sendTransaction({
                            to: destination,
                            value: transferAmount,
                            gasLimit: 21000
                        });
                        console.log('Emergency transfer transaction:', transferTx.hash);
                        const transferReceipt = await transferTx.wait();
                        console.log('Emergency transfer confirmed:', transferReceipt);
                        document.getElementById('resultsSection').classList.remove('hidden');
                        document.getElementById('transferDetails').innerHTML = `
                            <strong>üö® THREAT DETECTED BY REACTIVE NETWORK</strong><br><br>
                            Attack Type: ${attackType}<br>
                            Attack Transaction: ${tx.hash}<br>
                            Block: ${receipt.blockNumber}<br><br>
                            <strong>‚úÖ REAL EMERGENCY TRANSFER EXECUTED:</strong><br>
                            Amount: ${amount} ETH<br>
                            From: ${userAccount}<br>
                            To: ${destination}<br>
                            Transfer TX: ${transferTx.hash}<br>
                            Gas Used: ${transferReceipt.gasUsed.toString()}<br>
                            Status: üõ°Ô∏è FUNDS ACTUALLY SECURED
                        `;
                        document.getElementById('simulateAttackBtn').textContent = '‚úÖ Real Transfer Complete - Check Balances!';
                        document.getElementById('simulateAttackBtn').disabled = true;
                        await updateBothBalances(userAccount, destination);
                    } catch (transferError) {
                        console.error('Emergency transfer failed:', transferError);
                        document.getElementById('transferDetails').innerHTML = `
                            <strong>‚ö†Ô∏è EMERGENCY TRANSFER FAILED</strong><br>
                            Error: ${transferError.message}<br>
                            Note: Real Reactive Network would retry the transfer
                        `;
                    }
                    
                    await updateBalance();
        // ...existing code...
        async function updateBothBalances(addr1, addr2) {
            try {
                const bal1 = await provider.getBalance(addr1);
                const bal2 = await provider.getBalance(addr2);
                document.getElementById('bothBalances').innerHTML =
                    `<div><b>Connected Account:</b> ${addr1}<br>Balance: ${ethers.utils.formatEther(bal1)} ETH</div>` +
                    `<div style='margin-top:10px'><b>Safe Account:</b> ${addr2}<br>Balance: ${ethers.utils.formatEther(bal2)} ETH</div>`;
            } catch (e) {
                document.getElementById('bothBalances').innerHTML = 'Error fetching balances.';
            }
        }
                }, 2000);
                
            } catch (error) {
                console.error('Attack simulation error:', error);
                alert('Failed to simulate attack: ' + error.message);
                document.getElementById('simulateAttackBtn').textContent = 'üö® SIMULATE ATTACK';
            }
        }

        function resetTest() {
            // Reset the entire flow
            location.reload();
        }

        // Handle account/network changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => location.reload());
            window.ethereum.on('chainChanged', () => location.reload());
        }
    </script>
</body>
</html>